name: Quality Gate

on:
  push:
    branches: [ main, develop, feature/*, fix/*, hotfix/* ]
  pull_request:
    branches: [ main, develop ]

jobs:
  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false  # Continue running all matrix jobs even if one fails
      matrix:
        node-version: [20]
        python-version: ['3.9', '3.10', '3.11', '3.12']

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install root dependencies
      run: npm ci

    - name: Install frontend dependencies
      if: ${{ hashFiles('frontend/package.json') != '' }}
      run: cd frontend && npm ci

    - name: Install backend dependencies
      if: ${{ hashFiles('backend/requirements.txt') != '' || hashFiles('requirements.txt') != '' }}
      run: |
        # Detect backend directory location
        if [[ -f backend/requirements.txt ]]; then
          BACKEND_DIR="backend"
        elif [[ -f requirements.txt ]]; then
          BACKEND_DIR="."
        else
          echo "No requirements.txt found, skipping backend dependencies"
          exit 0
        fi

        cd "$BACKEND_DIR"

        # Install main dependencies
        if [[ -f requirements.txt ]]; then
          pip install -r requirements.txt
        fi

        # Install dev dependencies if they exist
        if [[ -f requirements-dev.txt ]]; then
          echo "ðŸ“¦ Installing development dependencies from requirements-dev.txt"
          pip install -r requirements-dev.txt
        else
          # Fallback: install quality tools manually if no requirements-dev.txt
          echo "âš ï¸  No requirements-dev.txt found, installing quality tools manually"
          pip install black isort flake8 mypy pytest pytest-cov
        fi

    - name: Install quality tools
      run: |
        pip install pre-commit commitizen detect-secrets

    - name: Create secrets baseline if missing
      run: |
        if [[ ! -f .secrets.baseline ]]; then
          detect-secrets scan . > .secrets.baseline 2>/dev/null || echo '{}' > .secrets.baseline
        fi

    - name: Run comprehensive quality gate
      run: |
        echo "ðŸš¨ RUNNING COMPREHENSIVE QUALITY GATE - ZERO TOLERANCE FOR ISSUES"
        echo "==============================================================="
        bash scripts/quality-gate.sh all

    - name: Quality gate summary
      if: success()
      run: |
        echo ""
        echo "ðŸŽ‰ QUALITY GATE PASSED!"
        echo "All code meets quality standards:"
        echo "âœ… No ESLint errors or warnings"
        echo "âœ… TypeScript compilation successful" 
        echo "âœ… All tests passing"
        echo "âœ… Python code properly formatted and linted"
        echo "âœ… No security issues detected"
        echo ""
        echo "Ready for deployment! ðŸš€"